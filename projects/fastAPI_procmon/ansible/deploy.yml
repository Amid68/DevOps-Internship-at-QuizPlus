---
# deploy.yml
# Main deployment playbook - this is what Jenkins calls
# Keeping it simple and focused on the deployment task

- name: Deploy FastAPI Application with Zero Downtime
  hosts: ec2_servers
  become: true
  gather_facts: false  # We don't need facts, speeds up execution
  
  # Variables passed from Jenkins or command line
  vars:
    docker_image: "{{ image_name }}"  # Passed from Jenkins
    deployment_environment: "{{ deployment_environment }}"  # Passed from Jenkins
  
  # Pre-flight checks before deployment
  pre_tasks:
    - name: Validate required variables
      assert:
        that:
          - docker_image is defined
          - deployment_environment is defined
        fail_msg: "Missing required variables: docker_image and deployment_environment must be provided"
    
    - name: Check Docker daemon is running
      systemd:
        name: docker
        state: started
      become_user: root
  
  # Main deployment using our role
  roles:
    - role: fastapi_deployment
      tags: ['deploy']
